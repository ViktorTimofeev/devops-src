# Руководство по развертыванию скрипта настройки Debian 12

## Обзор

Этот документ содержит подробные инструкции по развертыванию и использованию скрипта настройки сервера Debian 12. Скрипт предназначен для автоматической настройки и защиты сервера с максимальными мерами безопасности.

## Структура проекта

```
debian12/
├── debian12-server-setup.sh    # Основной скрипт настройки
├── security-check.sh           # Скрипт проверки безопасности
├── install-from-github.sh       # Скрипт установки с GitHub
├── config.env                   # Конфигурационный файл
├── Makefile                     # Makefile для управления
├── README.md                    # Основная документация
└── DEPLOYMENT.md               # Данный файл
```

## Предварительные требования

### Системные требования
- **ОС**: Debian 12 (Bookworm) или новее
- **Архитектура**: x86_64, ARM64
- **Память**: Минимум 1GB RAM
- **Диск**: Минимум 10GB свободного места
- **Сеть**: Подключение к интернету

### Права доступа
- Скрипт должен запускаться с правами `root`
- Необходимы права на установку пакетов
- Доступ к системным конфигурационным файлам

### Зависимости
- `curl` или `wget` для скачивания
- `git` для работы с репозиторием
- `bash` версии 4.0 или новее

## Способы установки

### 1. Установка с GitHub (Рекомендуется)

```bash
# Быстрая установка одной командой
curl -fsSL https://raw.githubusercontent.com/your-username/your-repo/main/debian12/install-from-github.sh | bash
```

### 2. Локальная установка

```bash
# Клонирование репозитория
git clone https://github.com/your-username/your-repo.git
cd your-repo/debian12

# Запуск установки
sudo ./install-from-github.sh
```

### 3. Ручная установка

```bash
# Скачивание скриптов
wget https://raw.githubusercontent.com/your-username/your-repo/main/debian12/debian12-server-setup.sh
wget https://raw.githubusercontent.com/your-username/your-repo/main/debian12/security-check.sh

# Предоставление прав
chmod +x debian12-server-setup.sh security-check.sh

# Запуск настройки
sudo ./debian12-server-setup.sh
```

## Конфигурация

### Интерактивная настройка пользователя

При запуске скрипта вам будет предложено настроить пользователя администратора:

#### Требования к имени пользователя
- Должно содержать только буквы, цифры, дефис и подчеркивание
- Длина от 3 до 32 символов
- Не должно быть зарезервированным системой именем (root, admin, daemon, bin, sys и др.)
- Не должно совпадать с существующими пользователями

#### Требования к паролю
- Минимум 8 символов
- Должен содержать минимум 3 из 4 типов символов:
  - Заглавные буквы (A-Z)
  - Строчные буквы (a-z)
  - Цифры (0-9)
  - Специальные символы (!@#$%^&*)
- Требуется подтверждение пароля

#### Примеры валидных данных
```bash
# Имя пользователя
myadmin
server-admin
admin123
user_name

# Пароль (должен содержать минимум 3 типа символов)
MySecure123!
AdminPass2024
Server#2024
```

### Дополнительные параметры

Для других настроек отредактируйте файл `config.env`:

```bash
# Настройки SSH
SSH_PORT="22"

# Настройки безопасности
FAIL2BAN_BANTIME="3600"
UFW_ALLOW_PORTS="22,80,443"

# Настройки мониторинга
MONITOR_DISK_THRESHOLD="80"
MONITOR_MEMORY_THRESHOLD="80"
```

### Настройка GitHub репозитория

Обновите переменные в скриптах:

```bash
# В install-from-github.sh
GITHUB_REPO="your-username/your-repo"

# В config.env
GITHUB_REPO="your-username/your-repo"
```

## Процесс установки

### Этап 1: Подготовка
1. Проверка прав root
2. Проверка версии Debian
3. Проверка подключения к интернету
4. Создание лог-файлов

### Этап 2: Обновление системы
1. Обновление списка пакетов
2. Установка обновлений безопасности
3. Очистка кэша пакетов

### Этап 3: Установка пакетов
1. Базовые утилиты
2. Пакеты безопасности
3. Системные утилиты
4. Мониторинг и логирование

### Этап 4: Настройка безопасности
1. Конфигурация SSH
2. Настройка файрвола UFW
3. Установка и настройка fail2ban
4. Настройка AppArmor и auditd

### Этап 5: Создание пользователей
1. Интерактивный ввод имени администратора
2. Интерактивный ввод пароля с валидацией
3. Создание пользователя с правами sudo
4. Создание SSH директории и настройка алиасов

### Этап 6: Системные настройки
1. Автоматические обновления
2. Мониторинг системы
3. Резервное копирование
4. Сетевые параметры

### Этап 7: Завершение
1. Создание отчетов
2. Проверка служб
3. Предложение перезагрузки

## Использование Makefile

### Доступные команды

```bash
# Показать помощь
make help

# Установка с GitHub
make install

# Локальная настройка
make setup

# Проверка безопасности
make security

# Проверка скриптов
make check

# Тестирование
make test

# Валидация конфигурации
make validate

# Быстрая установка (все этапы)
make quick-install
```

### Установка зависимостей для разработки

```bash
# Установка shellcheck и других инструментов
make dev-deps

# Проверка системы
make system-check

# Создание архива
make archive
```

## Мониторинг и обслуживание

### Проверка статуса служб

```bash
# Статус основных служб
systemctl status ssh ufw fail2ban auditd apparmor

# Статус файрвола
ufw status verbose

# Статус fail2ban
fail2ban-client status
```

### Проверка безопасности

```bash
# Запуск проверки безопасности
security-check

# Или напрямую
/usr/local/bin/security-check.sh
```

### Обновление скриптов

```bash
# Обновление с GitHub
/usr/local/bin/update-security-scripts.sh

# Или через curl
curl -fsSL https://raw.githubusercontent.com/your-username/your-repo/main/debian12/security-check.sh -o /usr/local/bin/security-check.sh
```

## Устранение неполадок

### Частые проблемы

#### 1. Ошибка прав доступа
```bash
# Решение
sudo chmod +x debian12-server-setup.sh
sudo ./debian12-server-setup.sh
```

#### 2. Ошибка подключения к интернету
```bash
# Проверка подключения
ping -c 3 8.8.8.8

# Проверка DNS
nslookup google.com
```

#### 3. Ошибка установки пакетов
```bash
# Обновление списка пакетов
sudo apt update

# Очистка кэша
sudo apt clean
sudo apt autoclean
```

#### 4. Проблемы с SSH
```bash
# Проверка конфигурации
sudo sshd -t

# Перезапуск службы
sudo systemctl restart ssh
```

#### 5. Проблемы с файрволом
```bash
# Сброс правил
sudo ufw --force reset

# Включение файрвола
sudo ufw enable
```

### Логи и диагностика

#### Основные лог-файлы
- `/var/log/debian12-setup.log` - Лог установки
- `/var/log/auth.log` - Логи аутентификации
- `/var/log/fail2ban.log` - Логи fail2ban
- `/var/log/system-monitor.log` - Логи мониторинга

#### Отчеты
- `/root/setup-report-YYYY-MM-DD.txt` - Отчет установки
- `/root/security-report-YYYY-MM-DD.txt` - Отчет безопасности

#### Диагностические команды
```bash
# Проверка системных ресурсов
htop
df -h
free -h

# Проверка сетевых соединений
ss -tlnp
netstat -tuln

# Проверка процессов
ps aux | grep -E "(ssh|fail2ban|ufw)"
```

## Безопасность

### Рекомендации после установки

1. **Настройте SSH ключи для созданного пользователя**
   ```bash
   ssh-copy-id your-admin-user@your-server-ip
   ```

2. **Проверьте права пользователя**
   ```bash
   sudo -l
   ```

3. **Обновите базы антивируса**
   ```bash
   sudo freshclam
   ```

4. **Запустите проверку на rootkit**
   ```bash
   sudo rkhunter --check
   ```

5. **Проверьте целостность файлов**
   ```bash
   sudo aide --check
   ```

### Регулярное обслуживание

#### Еженедельные задачи
- Проверка обновлений безопасности
- Анализ логов безопасности
- Проверка целостности файлов
- Обновление баз антивируса

#### Ежемесячные задачи
- Полная проверка безопасности
- Обновление системы
- Проверка резервных копий
- Анализ производительности

## Расширенная настройка

### Дополнительные пакеты

```bash
# Веб-сервер
sudo apt install nginx apache2

# База данных
sudo apt install postgresql mysql-server

# Мониторинг
sudo apt install prometheus grafana

# Контейнеризация
sudo apt install docker.io docker-compose
```

### Настройка мониторинга

```bash
# Установка Prometheus
wget https://github.com/prometheus/prometheus/releases/download/v2.45.0/prometheus-2.45.0.linux-amd64.tar.gz
tar xzf prometheus-2.45.0.linux-amd64.tar.gz
sudo mv prometheus-2.45.0.linux-amd64 /opt/prometheus
```

### Настройка резервного копирования в облако

```bash
# Установка AWS CLI
sudo apt install awscli

# Настройка S3 бэкапа
aws configure
```

## Поддержка и сообщество

### Получение помощи
- Проверьте логи ошибок
- Изучите документацию
- Обратитесь к сообществу

### Вклад в проект
- Сообщения об ошибках
- Предложения улучшений
- Pull requests

### Контакты
- GitHub Issues: [Ссылка на репозиторий]
- Email: [Ваш email]
- Документация: [Ссылка на документацию]

## Лицензия

Этот проект распространяется под лицензией MIT. См. файл LICENSE для подробностей.

## Версии

- **v1.0** - Первоначальная версия с базовой функциональностью
- **v1.1** - Планируется: улучшения безопасности и производительности
- **v1.2** - Планируется: поддержка дополнительных дистрибутивов

---

**Примечание**: Этот документ регулярно обновляется. Проверяйте актуальную версию в репозитории.
